<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saygının Tumblr Botu - Ana Sayfa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .user-info-card {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0; transform: translateY(20px);
        }
        .user-info-card.visible {
            opacity: 1; transform: translateY(0);
        }
        #actionResultOutput {
            margin-top: 1.5rem; padding: 1rem; background-color: #f8fafc;
            border: 1px solid #e2e8f0; border-radius: 0.5rem;
            max-height: 400px; overflow-y: auto;
            white-space: pre-wrap; word-break: break-all; font-size: 0.875rem;
        }
        .token-status {
            font-size: 0.75rem; padding: 0.25rem 0.5rem;
            border-radius: 0.25rem; margin-top: 0.5rem;
            display: inline-block;
        }
        .token-status.success { background-color: #dcfce7; color: #166534; border: 1px solid #86efac;}
        .token-status.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;}
        .token-status.loading { background-color: #e0e7ff; color: #3730a3; border: 1px solid #a5b4fc;}
        .reauth-button {
            background-color: #f59e0b; color: white;
            padding: 0.25rem 0.5rem; font-size: 0.75rem;
            border-radius: 0.25rem; margin-left: 0.5rem; cursor: pointer;
        }
        .reauth-button:hover { background-color: #d97706; }

        .progress-bar-container { background-color: #e9ecef; border-radius: 9999px; overflow: hidden; height: 0.625rem; /* h-2.5 Tailwind */ }
        .progress-bar { background-color: #3b82f6; /* Default blue, can be overridden */ height: 100%; text-align: center; transition: width 0.4s ease-in-out; }
        
        /* Dropdown for API Actions */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-slate-800 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center"><span class="font-semibold text-xl">Tumblr Uygulamam</span></div>
                <div class="add-user-container">
                    <button id="addNewUserButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                        Yeni Hesap Ekle / Giriş Yap
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="mb-6 p-4 bg-white rounded-xl shadow-lg">
             <h3 class="text-lg font-semibold text-slate-700 mb-3">Kayıtlı Hesaplar</h3>
             <button id="refreshAllLimitsButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 w-full sm:w-auto">
                Tüm Limitleri Yenile
            </button>
        </div>

        <div id="userInfoCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
             <div id="actionsAndResultsContainer" class="md:col-span-3">
                 <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Modüller ve İşlemler</h3>
                    <div id="actionsMenuDynamic" class="space-y-3">
                        <p id="noActionsMessage" class="text-slate-500 italic">Uygun eylem bulunamadı veya yüklenemedi.</p>
                    </div>
                </div>
                <div id="actionResultOutputContainer" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg" style="display:none;">
                     <h4 class="text-lg font-semibold text-slate-700 mb-2">Eylem Sonucu:</h4>
                     <pre id="actionResultOutput"></pre>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-[100]" style="display:none;">
            <div class="bg-white p-5 rounded-lg shadow-xl text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500 mx-auto mb-3"></div>
                <p class="text-slate-700 text-lg">Yükleniyor...</p>
            </div>
        </div>
        <div id="errorMessageContainer" class="fixed bottom-0 right-0 p-6 z-[100] max-w-sm w-full" style="display:none;">
            <div id="errorMessage" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-lg" role="alert">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-1-11a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2h-2a1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2h-2a1 1 0 0 1-1-1z"/></svg></div>
                    <div><p class="font-bold">Hata!</p><p class="text-sm" id="errorText"></p></div>
                     <button id="closeErrorButton" class="ml-auto -mx-1.5 -my-1.5 bg-red-100 text-red-500 rounded-lg focus:ring-2 focus:ring-red-400 p-1.5 hover:bg-red-200 inline-flex h-8 w-8" aria-label="Kapat"><span class="sr-only">Kapat</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // DOM Elementlerini seçme (değişiklik yok)
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageContainer = document.getElementById('errorMessageContainer');
        const errorText = document.getElementById('errorText');
        const closeErrorButton = document.getElementById('closeErrorButton');
        const actionsMenuDynamic = document.getElementById('actionsMenuDynamic');
        const noActionsMessage = document.getElementById('noActionsMessage');
        const actionResultOutputContainer = document.getElementById('actionResultOutputContainer');
        const actionResultOutput = document.getElementById('actionResultOutput');
        const addNewUserButton = document.getElementById('addNewUserButton');
        const userInfoCardsContainer = document.getElementById('userInfoCardsContainer');
        const refreshAllLimitsButton = document.getElementById('refreshAllLimitsButton');

        // Global değişkenler (değişiklik yok)
        let availableActions = [];
        let allRegisteredUsers = [];

        // Kullanıcı ve kartlarla ilgili tüm fonksiyonlar (değişiklik yok)
        async function fetchRegisteredUsersFromServer() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error(`Sunucu hatası (${response.status})`);
                const users = await response.json();
                allRegisteredUsers = users;
                return users;
            } catch (error) {
                showError(error.message || "Kayıtlı kullanıcı listesi yüklenemedi.");
                return [];
            }
        }

        function createUserInfoCardElement(appUsername) {
            const cardId = `user-card-${appUsername.replace(/\W/g, '_')}`;
            if (document.getElementById(cardId)) {
                return document.getElementById(cardId);
            }

            const card = document.createElement('div');
            card.id = cardId;
            card.className = 'bg-white p-4 rounded-xl shadow-lg user-info-card';
            
            card.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img data-field="userProfilePic" src="https://placehold.co/64x64/e2e8f0/cbd5e0?text=..." alt="Profil" class="w-16 h-16 rounded-full border-2 border-slate-200 object-cover">
                    <div class="flex-1 min-w-0">
                        <h2 data-field="userNameDisplay" class="text-lg font-bold text-slate-800 truncate">Yükleniyor...</h2>
                        <p class="text-xs text-indigo-600 hover:text-indigo-800 truncate">
                            <a data-field="userBlogUrl" href="#" target="_blank">...</a>
                        </p>
                         <div data-field="tokenStatusContainer" class="w-full text-left mt-1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center text-xs my-3">
                    <div class="bg-slate-50 p-1.5 rounded-md"><span data-field="followerCount" class="block font-bold text-slate-700">-</span><p class="text-slate-500">Takipçi</p></div>
                    <div class="bg-slate-50 p-1.5 rounded-md"><span data-field="followingCount" class="block font-bold text-slate-700">-</span><p class="text-slate-500">Takip</p></div>
                    <div class="bg-slate-50 p-1.5 rounded-md"><span data-field="userPostsCount" class="block font-bold text-slate-700">-</span><p class="text-slate-500">Gönderi</p></div>
                    <div class="bg-slate-50 p-1.5 rounded-md"><span data-field="userLikesCount" class="block font-bold text-slate-700">-</span><p class="text-slate-500">Beğeni</p></div>
                </div>
                <h4 class="text-sm font-semibold text-slate-700 mb-1.5">Günlük Limitler:</h4>
                <div data-field="limitsContent" class="w-full space-y-2 text-sm">
                    <p class="text-slate-400 italic text-xs" data-limit-loading-message>Limitler yükleniyor...</p>
                    <div data-limit-type="follows" style="display: none;">
                        <div class="flex justify-between items-center text-xs mb-0.5">
                            <span class="text-slate-600 font-medium">Takip Etme</span>
                            <span class="text-slate-500" data-limit-usage-text>0 / 0</span>
                        </div>
                        <div class="progress-bar-container"><div class="progress-bar bg-sky-500" data-limit-progress-bar style="width: 0%;"></div></div>
                    </div>
                    <div data-limit-type="likes" style="display: none;">
                        <div class="flex justify-between items-center text-xs mb-0.5">
                            <span class="text-slate-600 font-medium">Beğeni</span>
                            <span class="text-slate-500" data-limit-usage-text>0 / 0</span>
                        </div>
                        <div class="progress-bar-container"><div class="progress-bar bg-pink-500" data-limit-progress-bar style="width: 0%;"></div></div>
                    </div>
                    <p class="text-red-500 italic text-xs" data-limit-error-message style="display: none;">Limit bilgileri alınamadı.</p>
                </div>
            `;
            userInfoCardsContainer.appendChild(card);
            requestAnimationFrame(() => card.classList.add('visible'));
            return card;
        }

        function displayUserInfoInCard(cardElement, userData) {
            if (!cardElement || !userData || !userData.blog || !userData.user) {
                return;
            }
            const blogData = userData.blog; const userDataUser = userData.user;

            cardElement.querySelector('[data-field="userProfilePic"]').src = blogData.avatar?.[0]?.url || 'https://placehold.co/128x128/e2e8f0/cbd5e0?text=?';
            cardElement.querySelector('[data-field="userNameDisplay"]').textContent = blogData.title || blogData.name || '...';
            const blogUrlLink = cardElement.querySelector('[data-field="userBlogUrl"]');
            blogUrlLink.href = blogData.url || '#';
            blogUrlLink.textContent = blogData.url ? blogData.url.replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\/$/, '') : '...';
            cardElement.querySelector('[data-field="followerCount"]').textContent = blogData.followers?.toLocaleString() || '0';
            cardElement.querySelector('[data-field="userPostsCount"]').textContent = blogData.posts?.toLocaleString() || '0';
            cardElement.querySelector('[data-field="followingCount"]').textContent = userDataUser.following?.toLocaleString() || '0';
            cardElement.querySelector('[data-field="userLikesCount"]').textContent = userDataUser.likes?.toLocaleString() || '0';
        }

        function displayUserLimitsInCard(cardElement, limitsData) {
            const limitsContent = cardElement.querySelector('[data-field="limitsContent"]');
            if (!limitsContent) return;

            const loadingMessage = limitsContent.querySelector('[data-limit-loading-message]');
            const errorMessage = limitsContent.querySelector('[data-limit-error-message]');
            const followsElement = limitsContent.querySelector('[data-limit-type="follows"]');
            const likesElement = limitsContent.querySelector('[data-limit-type="likes"]');

            loadingMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            followsElement.style.display = 'none';
            likesElement.style.display = 'none';

            let likesUsed = 0, likesTotal = 1000;
            let followsUsed = 0, followsTotal = 200;
            let dataParsedSuccessfully = false;

            if (limitsData) {
                if (limitsData.likes && typeof limitsData.likes.limit !== 'undefined' && typeof limitsData.likes.remaining !== 'undefined') {
                    likesTotal = parseInt(limitsData.likes.limit, 10) || likesTotal;
                    likesUsed = Math.max(0, likesTotal - (parseInt(limitsData.likes.remaining, 10) || 0));
                    dataParsedSuccessfully = true;
                }
                if (limitsData.follows && typeof limitsData.follows.limit !== 'undefined' && typeof limitsData.follows.remaining !== 'undefined') {
                    followsTotal = parseInt(limitsData.follows.limit, 10) || followsTotal;
                    followsUsed = Math.max(0, followsTotal - (parseInt(limitsData.follows.remaining, 10) || 0));
                    dataParsedSuccessfully = true;
                }
                else if (limitsData.usage && limitsData.limits) { 
                    if (limitsData.usage.likes && limitsData.limits.likes) {
                        likesUsed = parseInt(limitsData.usage.likes.count, 10) || 0;
                        likesTotal = parseInt(limitsData.limits.likes.total, 10) || likesTotal;
                        dataParsedSuccessfully = true;
                    }
                    if (limitsData.usage.follows && limitsData.limits.follows) {
                        followsUsed = parseInt(limitsData.usage.follows.count, 10) || 0;
                        followsTotal = parseInt(limitsData.limits.follows.total, 10) || followsTotal;
                        dataParsedSuccessfully = true;
                    }
                }
                 else if (limitsData.user) { 
                    if (typeof limitsData.user.likes !== 'undefined' && typeof limitsData.user.likes_limit !== 'undefined') {
                        likesUsed = parseInt(limitsData.user.likes, 10) || 0;
                        likesTotal = parseInt(limitsData.user.likes_limit, 10) || likesTotal;
                        dataParsedSuccessfully = true;
                    }
                    if (typeof limitsData.user.following_limit !== 'undefined') {
                        followsTotal = parseInt(limitsData.user.following_limit, 10) || followsTotal;
                        followsUsed = 0;
                        dataParsedSuccessfully = true;
                    }
                  }
                 else if (typeof limitsData.likes_used !== 'undefined' && typeof limitsData.likes_total !== 'undefined') { 
                    likesUsed = parseInt(limitsData.likes_used, 10) || 0;
                    likesTotal = parseInt(limitsData.likes_total, 10) || likesTotal;
                    if (typeof limitsData.follows_used !== 'undefined' && typeof limitsData.follows_total !== 'undefined') {
                        followsUsed = parseInt(limitsData.follows_used, 10) || 0;
                        followsTotal = parseInt(limitsData.follows_total, 10) || followsTotal;
                    }
                    dataParsedSuccessfully = true;
                 }
            }

            if (!dataParsedSuccessfully) {
                errorMessage.textContent = 'Limit bilgileri alınamadı veya format anlaşılamadı.';
                errorMessage.style.display = 'block';
                return;
            }

            const updateLimitElement = (element, used, total) => {
                if (!element) return;
                element.style.display = 'block';
                const percentage = total > 0 ? (used / total) * 100 : 0;
                element.querySelector('[data-limit-usage-text]').textContent = `${used.toLocaleString()} / ${total.toLocaleString()}`;
                element.querySelector('[data-limit-progress-bar]').style.width = `${Math.min(100, percentage)}%`;
            };

            updateLimitElement(likesElement, likesUsed, likesTotal);
            updateLimitElement(followsElement, followsUsed, followsTotal);
        }

        function updateTokenStatusInCard(cardElement, statusType, message, appUsernameForReauth = null) {
            const tokenStatusContainer = cardElement.querySelector('[data-field="tokenStatusContainer"]');
            if (!tokenStatusContainer) return;

            let statusClass = 'token-status ';
            if (statusType === 'loading') statusClass += 'loading';
            else if (statusType === 'success') statusClass += 'success';
            else if (statusType === 'error') statusClass += 'error';

            let reauthButtonHtml = '';
            if (statusType === 'error' && appUsernameForReauth) {
                 reauthButtonHtml = `<button class="reauth-button" onclick="redirectToLoginForReauth('${appUsernameForReauth}')">Yeniden Giriş</button>`;
            }

            tokenStatusContainer.innerHTML = `<span class="${statusClass}">${message}</span> ${reauthButtonHtml}`;
        }
        
        function redirectToLoginForReauth(appUsername) {
            window.location.href = `/login.html?flow=reauth&user_to_reauth=${encodeURIComponent(appUsername)}`;
        }

        async function fetchTumblrUserDataForAppUser(appUsername, cardElement) {
            updateTokenStatusInCard(cardElement, 'loading', 'Veriler yükleniyor...');
            try {
                const response = await fetch(`/api/tumblr-data?user=${encodeURIComponent(appUsername)}`);
                const responseData = await response.json(); 
                if (!response.ok) {
                    const errorMessage = responseData.error || `Sunucu hatası (${response.status})`;
                    updateTokenStatusInCard(cardElement, 'error', `Veri hatası: ${errorMessage}`, appUsername);
                    throw new Error(errorMessage); 
                }
                updateTokenStatusInCard(cardElement, 'success', 'Token geçerli.');
                displayUserInfoInCard(cardElement, responseData);
            } catch (error) {
                // error already shown in card
            }
        }
        
        async function fetchUserLimitsForAppUser(appUsername, cardElement) {
            try {
                const response = await fetch(`/api/user-limits?user=${encodeURIComponent(appUsername)}`);
                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(responseData.error || `Limit alınamadı (${response.status})`);
                }
                displayUserLimitsInCard(cardElement, responseData); 
            } catch (error) {
                const limitsContent = cardElement.querySelector('[data-field="limitsContent"]');
                if (limitsContent) {
                    limitsContent.querySelector('[data-limit-loading-message]').style.display = 'none';
                    const errorMsgElement = limitsContent.querySelector('[data-limit-error-message]');
                    errorMsgElement.textContent = error.message || "Kullanıcı limitleri alınamadı.";
                    errorMsgElement.style.display = 'block';
                }
            }
        }
        
        async function populateAllUserCards() {
            showLoading();
            const users = await fetchRegisteredUsersFromServer();
            userInfoCardsContainer.innerHTML = '';
            
            if (!users || users.length === 0) {
                userInfoCardsContainer.innerHTML = '<p class="text-slate-500 italic col-span-full">Kayıtlı kullanıcı bulunamadı.</p>';
                hideLoading();
                return;
            }

            const allPromises = users.map(async (user) => {
                const cardElement = createUserInfoCardElement(user.appUsername);
                await fetchTumblrUserDataForAppUser(user.appUsername, cardElement);
                await fetchUserLimitsForAppUser(user.appUsername, cardElement);
            });

            await Promise.allSettled(allPromises);
            hideLoading();
        }

        /**
         * GÜNCELLENDİ: Bu fonksiyon artık '/api/list-actions' endpoint'ini kullanarak
         * modül listesini doğrudan sunucudan alır.
         */
        async function fetchAvailableActions() { 
            try {
                // Sunucunun sağladığı API endpoint'ini çağırıyoruz.
                const response = await fetch('/api/list-actions');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); // Hata mesajı JSON olmayabilir
                    throw new Error(errorData.error || `Sunucu eylemleri listelerken bir hata oluştu (${response.status})`);
                }
                
                // Sunucudan gelen JSON verisini doğrudan global `availableActions` değişkenine atıyoruz.
                availableActions = await response.json();
                
                // Arayüzü doldurma fonksiyonunu çağırıyoruz.
                populateActionsMenu();

            } catch (error) {
                showError(error.message || "Eylemler yüklenemedi.");
                noActionsMessage.textContent = "Modüller yüklenirken bir hata oluştu: " + error.message;
                noActionsMessage.style.display = 'block';
            }
        }


        function populateActionsMenu() { // Bu fonksiyonun içeriği aynı kaldı, çünkü gruplama mantığı doğru çalışıyor.
            actionsMenuDynamic.innerHTML = '';
            const pageNavContainer = document.createElement('div');
            pageNavContainer.className = "space-y-3";
            
            const details = document.createElement('details');
            details.className = "group mt-3";
            details.innerHTML = `
                <summary class="block w-full bg-sky-600 hover:bg-sky-700 text-white font-medium py-2.5 px-4 rounded-lg text-center transition duration-150 cursor-pointer">
                    Diğer API İşlemleri
                </summary>
                <div class="mt-2 p-3 border rounded-md bg-gray-50 space-y-2"></div>
            `;
            const apiActionList = details.querySelector('div');
            let apiActionCount = 0;
            let pageNavCount = 0;

            if (availableActions && availableActions.length > 0) {
                availableActions.forEach(action => {
                    if (action.type === 'pageNavigation') {
                        const link = document.createElement('a');
                        link.textContent = action.displayName || action.id;
                        link.href = action.targetPage; 
                        link.className = 'block w-full bg-teal-600 hover:bg-teal-700 text-white font-medium py-2.5 px-4 rounded-lg text-center transition duration-150';
                        pageNavContainer.appendChild(link);
                        pageNavCount++;
                    } else if (action.type === 'apiAction') { 
                        const button = document.createElement('button');
                        button.textContent = action.displayName || action.id;
                        button.className = 'block w-full bg-slate-500 hover:bg-slate-600 text-white font-medium py-2 px-3 rounded-lg text-left text-sm transition duration-150';
                        button.addEventListener('click', () => handleApiActionClick(action));
                        apiActionList.appendChild(button);
                        apiActionCount++;
                    }
                });

                if (pageNavCount > 0) {
                    actionsMenuDynamic.appendChild(pageNavContainer);
                }
                if (apiActionCount > 0) {
                    actionsMenuDynamic.appendChild(details);
                }
                
                if (pageNavCount > 0 || apiActionCount > 0) {
                    noActionsMessage.style.display = 'none';
                } else {
                    noActionsMessage.textContent = 'Sunucudan geçerli modül bulunamadı.';
                    noActionsMessage.style.display = 'block';
                }

            } else {
                noActionsMessage.style.display = 'block';
            }
        }
        
        async function handleApiActionClick(actionFullConfig) { // Değişiklik yok
            let params = {};
            if (actionFullConfig.params && actionFullConfig.params.param) {
                const paramDefs = Array.isArray(actionFullConfig.params.param) ? actionFullConfig.params.param : [actionFullConfig.params.param];
                for (const paramDef of paramDefs) {
                    const promptText = paramDef.prompt || `Değer girin: ${paramDef.name}`;
                    const defaultValue = paramDef.default || '';
                    const value = prompt(promptText, defaultValue);

                    if (paramDef.required === 'true' && (!value || value.trim() === '')) {
                        alert("Gerekli parametre boş bırakılamaz: " + paramDef.name);
                        return;
                    }
                    if (value === null) return; // Kullanıcı iptale bastı
                    params[paramDef.name] = value;
                }
            }

            let targetAppUsername = null;
            if (actionFullConfig.authenticationType === 'userToken') {
                if (allRegisteredUsers.length === 0) return alert("İşlem için kayıtlı kullanıcı yok.");
                
                if (allRegisteredUsers.length === 1) {
                    targetAppUsername = allRegisteredUsers[0].appUsername;
                } else {
                    const userNames = allRegisteredUsers.map(u => u.appUsername).join(', ');
                    const choice = prompt(`Eylem hangi kullanıcı için çalışsın?\n(${userNames})`, allRegisteredUsers[0].appUsername);
                    if (!choice || !allRegisteredUsers.some(u => u.appUsername === choice)) {
                        alert("Geçersiz kullanıcı seçimi.");
                        return;
                    }
                    targetAppUsername = choice;
                }
            }
            
            showLoading();
            try {
                // Sunucuya /api/execute-action isteği (değişiklik yok)
                const response = await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actionId: actionFullConfig.id, params, appUsername: targetAppUsername })
                });
                const result = await response.json();
                if (!response.ok) throw result;
                actionResultOutput.textContent = JSON.stringify(result.data, null, 2);
                actionResultOutputContainer.style.display = 'block';
            } catch (error) {
                const errorMessage = error.error || error.message || 'Bilinmeyen bir hata oluştu.';
                showError(errorMessage);
                if (error.needsReAuth && targetAppUsername) {
                    const cardElement = document.getElementById(`user-card-${targetAppUsername.replace(/\W/g, '_')}`);
                    if (cardElement) updateTokenStatusInCard(cardElement, 'error', 'Token Hatası!', targetAppUsername);
                }
            } finally {
                hideLoading();
            }
        }
        
        // Geri kalan yardımcı fonksiyonlar ve olay dinleyiciler (değişiklik yok)
        async function handleRefreshAllLimits() {
            showLoading();
            const refreshPromises = allRegisteredUsers.map(async (user) => {
                const cardElement = document.getElementById(`user-card-${user.appUsername.replace(/\W/g, '_')}`);
                if (cardElement) await fetchUserLimitsForAppUser(user.appUsername, cardElement);
            });
            await Promise.allSettled(refreshPromises);
            hideLoading();
        }

        function showLoading() { loadingIndicator.style.display = 'flex'; }
        function hideLoading() { loadingIndicator.style.display = 'none'; }
        function showError(message) { errorText.textContent = message; errorMessageContainer.style.display = 'block'; }
        function hideError() { errorMessageContainer.style.display = 'none'; }

        if (closeErrorButton) closeErrorButton.addEventListener('click', hideError);
        if (addNewUserButton) addNewUserButton.addEventListener('click', () => { window.location.href = '/login.html?flow=new'; });
        if (refreshAllLimitsButton) refreshAllLimitsButton.addEventListener('click', handleRefreshAllLimits);
        
        document.addEventListener('DOMContentLoaded', async () => { 
            await populateAllUserCards(); 
            // Sayfa yüklendiğinde artık güncellenmiş fonksiyon çağrılacak.
            await fetchAvailableActions(); 

            // URL temizleme (değişiklik yok)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('login_success') && window.history.replaceState) {
                const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
            }
        });
    </script>
</body>
</html>